<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INKFORM — Rorschach Compositor</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@300;400&display=swap');

  :root {
    --ink: #0a0a0f;
    --paper: #f5f2ed;
    --blot: #2d1f4e;
    --accent: #7c5cbf;
    --gray: #888;
    --panel: #111118;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--ink);
    color: var(--paper);
    font-family: 'IBM Plex Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  header {
    display: flex;
    align-items: baseline;
    gap: 16px;
    padding: 28px 40px 20px;
    border-bottom: 1px solid #222;
  }

  header h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 3rem;
    letter-spacing: 0.12em;
    color: var(--paper);
  }

  header span {
    font-size: 0.7rem;
    color: var(--gray);
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }

  .layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    height: calc(100vh - 77px);
  }

  /* SIDEBAR */
  .sidebar {
    border-right: 1px solid #222;
    padding: 28px 24px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 28px;
  }

  .section-label {
    font-size: 0.6rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 12px;
  }

  .upload-zone {
    border: 1px dashed #333;
    border-radius: 4px;
    padding: 20px 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    background: #0d0d14;
  }

  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--accent);
    background: #131320;
  }

  .upload-zone.has-file {
    border-color: #3a3a5c;
    border-style: solid;
  }

  .upload-zone input[type=file] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .upload-icon {
    font-size: 1.6rem;
    margin-bottom: 8px;
    opacity: 0.5;
  }

  .upload-zone p {
    font-size: 0.65rem;
    color: var(--gray);
    line-height: 1.6;
  }

  .upload-zone .filename {
    color: var(--paper);
    font-size: 0.7rem;
    margin-top: 4px;
    word-break: break-all;
  }

  /* CONTROLS */
  .control-group {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .control-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .control-row label {
    display: flex;
    justify-content: space-between;
    font-size: 0.65rem;
    color: var(--gray);
    letter-spacing: 0.1em;
  }

  .control-row label span {
    color: var(--paper);
    font-weight: 400;
  }

  input[type=range] {
    -webkit-appearance: none;
    width: 100%;
    height: 2px;
    background: #333;
    outline: none;
    border-radius: 1px;
  }

  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }

  .toggle-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.65rem;
    color: var(--gray);
    letter-spacing: 0.1em;
  }

  .toggle {
    width: 36px;
    height: 18px;
    background: #333;
    border-radius: 9px;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
  }

  .toggle.on { background: var(--accent); }

  .toggle::after {
    content: '';
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: white;
    top: 3px;
    left: 3px;
    transition: left 0.2s;
  }

  .toggle.on::after { left: 21px; }

  select {
    background: #0d0d14;
    border: 1px solid #333;
    color: var(--paper);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    padding: 6px 8px;
    width: 100%;
    outline: none;
    border-radius: 2px;
    cursor: pointer;
  }

  .btn-process {
    width: 100%;
    padding: 14px;
    background: var(--accent);
    color: white;
    border: none;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 0.2em;
    cursor: pointer;
    border-radius: 2px;
    transition: background 0.2s, transform 0.1s;
    margin-top: auto;
  }

  .btn-process:hover { background: #9070d8; }
  .btn-process:active { transform: scale(0.98); }
  .btn-process:disabled { background: #333; color: #555; cursor: not-allowed; }

  .btn-export {
    width: 100%;
    padding: 10px;
    background: transparent;
    color: var(--accent);
    border: 1px solid var(--accent);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.2s;
    text-transform: uppercase;
    display: none;
  }

  .btn-export:hover { background: var(--accent); color: white; }

  /* PREVIEW */
  .preview-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    gap: 20px;
    background: #050508;
    position: relative;
  }

  .canvas-wrap {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: 640px;
  }

  canvas {
    max-width: 100%;
    border: 1px solid #1a1a2e;
    display: block;
    border-radius: 2px;
  }

  #previewPlaceholder {
    width: 640px;
    height: 360px;
    border: 1px dashed #222;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    border-radius: 2px;
    color: #333;
    max-width: 100%;
  }

  #previewPlaceholder .big {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    letter-spacing: 0.2em;
    color: #2a2a3a;
  }

  #previewPlaceholder p {
    font-size: 0.6rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }

  .playback-controls {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .btn-play {
    background: none;
    border: 1px solid #333;
    color: var(--paper);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    padding: 8px 20px;
    cursor: pointer;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    border-radius: 2px;
    transition: all 0.2s;
    display: none;
  }

  .btn-play:hover { border-color: var(--accent); color: var(--accent); }

  .status-bar {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.6rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--gray);
    white-space: nowrap;
  }

  .progress-bar {
    width: 200px;
    height: 2px;
    background: #222;
    border-radius: 1px;
    overflow: hidden;
    display: none;
  }

  .progress-fill {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 0.1s;
  }

  .time-display {
    font-size: 0.6rem;
    color: var(--gray);
    letter-spacing: 0.1em;
    display: none;
  }

  /* Ink splat decorations */
  .ink-deco {
    position: fixed;
    border-radius: 50%;
    pointer-events: none;
    opacity: 0.04;
    filter: blur(60px);
  }

  .ink-deco-1 { width: 300px; height: 300px; background: var(--accent); top: -100px; right: -100px; }
  .ink-deco-2 { width: 200px; height: 200px; background: #1a0a3e; bottom: 100px; left: 200px; }
</style>
</head>
<body>

<div class="ink-deco ink-deco-1"></div>
<div class="ink-deco ink-deco-2"></div>

<header>
  <h1>INKFORM</h1>
  <span>Rorschach Video Compositor</span>
</header>

<div class="layout">
  <!-- SIDEBAR -->
  <div class="sidebar">

    <div>
      <div class="section-label">01 — Person Plate</div>
      <div class="upload-zone" id="plateZone">
        <input type="file" id="plateInput" accept="video/*">
        <div class="upload-icon">◈</div>
        <p>Drop person/subject video</p>
        <div class="filename" id="plateName"></div>
      </div>
    </div>

    <div>
      <div class="section-label">02 — Ink Blot Footage</div>
      <div class="upload-zone" id="inkZone">
        <input type="file" id="inkInput" accept="video/*">
        <div class="upload-icon">◉</div>
        <p>Drop ink blot video</p>
        <div class="filename" id="inkName"></div>
      </div>
    </div>

    <div>
      <div class="section-label">03 — Mirror</div>
      <div class="control-group">
        <div class="toggle-row">
          <span>Horizontal mirror (Rorschach)</span>
          <div class="toggle on" id="mirrorToggle" onclick="this.classList.toggle('on'); updatePreview()"></div>
        </div>
        <div class="toggle-row">
          <span>Vertical mirror</span>
          <div class="toggle" id="vmirrorToggle" onclick="this.classList.toggle('on'); updatePreview()"></div>
        </div>
      </div>
    </div>

    <div>
      <div class="section-label">04 — Grade</div>
      <div class="control-group">
        <div class="control-row">
          <label>Desaturate <span id="satVal">80%</span></label>
          <input type="range" id="saturation" min="0" max="100" value="80" oninput="updateVal('satVal', this.value+'%'); updatePreview()">
        </div>
        <div class="control-row">
          <label>Purple shift <span id="purpleVal">40%</span></label>
          <input type="range" id="purpleShift" min="0" max="100" value="40" oninput="updateVal('purpleVal', this.value+'%'); updatePreview()">
        </div>
        <div class="control-row">
          <label>Contrast <span id="contrastVal">1.3</span></label>
          <input type="range" id="contrast" min="50" max="250" value="130" oninput="updateVal('contrastVal', (this.value/100).toFixed(1)); updatePreview()">
        </div>
        <div class="control-row">
          <label>Brightness <span id="brightnessVal">0.9</span></label>
          <input type="range" id="brightness" min="30" max="150" value="90" oninput="updateVal('brightnessVal', (this.value/100).toFixed(1)); updatePreview()">
        </div>
      </div>
    </div>

    <div>
      <div class="section-label">05 — Ink Blend</div>
      <div class="control-group">
        <div class="control-row">
          <label>Ink opacity <span id="inkOpacVal">70%</span></label>
          <input type="range" id="inkOpacity" min="0" max="100" value="70" oninput="updateVal('inkOpacVal', this.value+'%'); updatePreview()">
        </div>
        <div class="control-row">
          <label>Ink threshold <span id="inkThreshVal">128</span></label>
          <input type="range" id="inkThresh" min="0" max="255" value="128" oninput="updateVal('inkThreshVal', this.value); updatePreview()">
        </div>
        <div class="control-row">
          <label>Blend mode</label>
          <select id="blendMode" onchange="updatePreview()">
            <option value="multiply">Multiply</option>
            <option value="screen">Screen</option>
            <option value="overlay">Overlay</option>
            <option value="soft-light">Soft Light</option>
            <option value="hard-light">Hard Light</option>
            <option value="luminosity">Luminosity</option>
          </select>
        </div>
      </div>
    </div>

    <div>
      <div class="section-label">06 — Background</div>
      <div class="control-group">
        <div class="toggle-row">
          <span>White paper background</span>
          <div class="toggle on" id="bgToggle" onclick="this.classList.toggle('on'); updatePreview()"></div>
        </div>
      </div>
    </div>

    <button class="btn-process" id="processBtn" onclick="processVideo()" disabled>
      PROCESS COMPOSITE
    </button>

    <button class="btn-export" id="exportBtn" onclick="exportFrame()">
      ↓ Export Current Frame (PNG)
    </button>

  </div>

  <!-- PREVIEW -->
  <div class="preview-area">
    <div class="canvas-wrap">
      <div id="previewPlaceholder">
        <div class="big">LOAD FOOTAGE</div>
        <p>Upload both videos to begin</p>
      </div>
      <canvas id="outputCanvas" style="display:none"></canvas>
    </div>

    <div class="playback-controls">
      <button class="btn-play" id="playBtn" onclick="togglePlay()">▶ Play</button>
      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
    </div>

    <div class="status-bar" id="statusBar">AWAITING INPUT</div>
  </div>
</div>

<!-- Hidden video elements for processing -->
<video id="plateVideo" style="display:none" crossorigin="anonymous" loop></video>
<video id="inkVideo" style="display:none" crossorigin="anonymous" loop></video>
<canvas id="workCanvas" style="display:none"></canvas>
<canvas id="inkCanvas" style="display:none"></canvas>

<script>
  let plateReady = false, inkReady = false;
  let isPlaying = false;
  let animFrame = null;
  let processed = false;

  const plateVideo = document.getElementById('plateVideo');
  const inkVideo = document.getElementById('inkVideo');
  const outputCanvas = document.getElementById('outputCanvas');
  const workCanvas = document.getElementById('workCanvas');
  const inkCanvas = document.getElementById('inkCanvas');
  const ctx = outputCanvas.getContext('2d', { willReadFrequently: true });
  const wCtx = workCanvas.getContext('2d', { willReadFrequently: true });
  const iCtx = inkCanvas.getContext('2d', { willReadFrequently: true });

  function updateVal(id, val) {
    document.getElementById(id).textContent = val;
  }

  // Upload handling
  function setupUpload(inputId, zoneId, nameId, videoEl, flag) {
    const input = document.getElementById(inputId);
    const zone = document.getElementById(zoneId);
    const nameEl = document.getElementById(nameId);

    input.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      videoEl.src = url;
      videoEl.load();
      nameEl.textContent = file.name;
      zone.classList.add('has-file');
      videoEl.addEventListener('loadeddata', () => {
        if (flag === 'plate') plateReady = true;
        if (flag === 'ink') inkReady = true;
        checkReady();
      }, { once: true });
    });

    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
    zone.addEventListener('drop', e => {
      e.preventDefault();
      zone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('video/')) {
        input.files = e.dataTransfer.files;
        input.dispatchEvent(new Event('change'));
      }
    });
  }

  setupUpload('plateInput', 'plateZone', 'plateName', plateVideo, 'plate');
  setupUpload('inkInput', 'inkZone', 'inkName', inkVideo, 'ink');

  function checkReady() {
    if (plateReady && inkReady) {
      document.getElementById('processBtn').disabled = false;
      document.getElementById('statusBar').textContent = 'READY — CLICK PROCESS';
    }
  }

  function processVideo() {
    if (!plateReady || !inkReady) return;

    // Set canvas size from plate video
    const W = plateVideo.videoWidth || 640;
    const H = plateVideo.videoHeight || 360;
    outputCanvas.width = W;
    outputCanvas.height = H;
    workCanvas.width = W;
    workCanvas.height = H;
    inkCanvas.width = W;
    inkCanvas.height = H;

    document.getElementById('previewPlaceholder').style.display = 'none';
    outputCanvas.style.display = 'block';

    plateVideo.currentTime = 0;
    inkVideo.currentTime = 0;

    processed = true;
    startRender();

    document.getElementById('playBtn').style.display = 'inline-block';
    document.getElementById('progressBar').style.display = 'block';
    document.getElementById('timeDisplay').style.display = 'block';
    document.getElementById('exportBtn').style.display = 'block';
    document.getElementById('statusBar').textContent = 'PRESS PLAY TO ANIMATE';
  }

  function startRender() {
    if (animFrame) cancelAnimationFrame(animFrame);
    renderFrame();
  }

  function renderFrame() {
    if (!processed) return;

    const W = outputCanvas.width;
    const H = outputCanvas.height;

    const mirror = document.getElementById('mirrorToggle').classList.contains('on');
    const vmirror = document.getElementById('vmirrorToggle').classList.contains('on');
    const saturation = document.getElementById('saturation').value / 100;
    const purpleShift = document.getElementById('purpleShift').value / 100;
    const contrast = document.getElementById('contrast').value / 100;
    const brightness = document.getElementById('brightness').value / 100;
    const inkOpacity = document.getElementById('inkOpacity').value / 100;
    const inkThresh = parseInt(document.getElementById('inkThresh').value);
    const blendMode = document.getElementById('blendMode').value;
    const whiteBg = document.getElementById('bgToggle').classList.contains('on');

    // Draw plate onto work canvas
    wCtx.clearRect(0, 0, W, H);
    if (whiteBg) {
      wCtx.fillStyle = 'white';
      wCtx.fillRect(0, 0, W, H);
    } else {
      wCtx.fillStyle = 'black';
      wCtx.fillRect(0, 0, W, H);
    }

    // Draw person (mirror if needed)
    if (mirror) {
      // Draw left half mirrored
      const halfW = W / 2;
      wCtx.save();
      wCtx.drawImage(plateVideo, 0, 0, halfW, H, 0, 0, halfW, H);
      // Mirror right half from left
      wCtx.scale(-1, 1);
      wCtx.drawImage(plateVideo, 0, 0, halfW, H, -W, 0, halfW, H);
      wCtx.restore();
    } else {
      wCtx.drawImage(plateVideo, 0, 0, W, H);
    }

    if (vmirror) {
      const halfH = H / 2;
      // read current top half, flip to bottom
      const topData = wCtx.getImageData(0, 0, W, halfH);
      // create flipped version
      const tempC = document.createElement('canvas');
      tempC.width = W; tempC.height = halfH;
      const tCtx = tempC.getContext('2d');
      tCtx.putImageData(topData, 0, 0);
      wCtx.save();
      wCtx.scale(1, -1);
      wCtx.drawImage(tempC, 0, -H);
      wCtx.restore();
    }

    // Apply grade to work canvas
    let imgData = wCtx.getImageData(0, 0, W, H);
    let d = imgData.data;
    for (let i = 0; i < d.length; i += 4) {
      let r = d[i], g = d[i+1], b = d[i+2];
      // Desaturate
      const gray = 0.299*r + 0.587*g + 0.114*b;
      r = r + (gray - r) * saturation;
      g = g + (gray - g) * saturation;
      b = b + (gray - b) * saturation;
      // Contrast & brightness
      r = ((r/255 - 0.5) * contrast + 0.5) * 255 * brightness;
      g = ((g/255 - 0.5) * contrast + 0.5) * 255 * brightness;
      b = ((b/255 - 0.5) * contrast + 0.5) * 255 * brightness;
      // Purple shift
      r = r + 30 * purpleShift;
      b = b + 60 * purpleShift;
      g = g - 10 * purpleShift;
      d[i]   = Math.max(0, Math.min(255, r));
      d[i+1] = Math.max(0, Math.min(255, g));
      d[i+2] = Math.max(0, Math.min(255, b));
    }
    wCtx.putImageData(imgData, 0, 0);

    // Draw ink onto ink canvas
    iCtx.clearRect(0, 0, W, H);
    if (mirror) {
      const halfW = W / 2;
      iCtx.save();
      iCtx.drawImage(inkVideo, 0, 0, halfW, H, 0, 0, halfW, H);
      iCtx.scale(-1, 1);
      iCtx.drawImage(inkVideo, 0, 0, halfW, H, -W, 0, halfW, H);
      iCtx.restore();
    } else {
      iCtx.drawImage(inkVideo, 0, 0, W, H);
    }

    // Apply threshold to ink
    let inkData = iCtx.getImageData(0, 0, W, H);
    let id = inkData.data;
    for (let i = 0; i < id.length; i += 4) {
      const gray = 0.299*id[i] + 0.587*id[i+1] + 0.114*id[i+2];
      const val = gray < inkThresh ? 0 : 255;
      id[i] = id[i+1] = id[i+2] = val;
    }
    iCtx.putImageData(inkData, 0, 0);

    // Composite to output
    ctx.clearRect(0, 0, W, H);
    ctx.drawImage(workCanvas, 0, 0);

    ctx.globalAlpha = inkOpacity;
    ctx.globalCompositeOperation = blendMode;
    ctx.drawImage(inkCanvas, 0, 0);
    ctx.globalAlpha = 1.0;
    ctx.globalCompositeOperation = 'source-over';

    // Update progress
    if (isPlaying) {
      const dur = plateVideo.duration || 1;
      const t = plateVideo.currentTime;
      document.getElementById('progressFill').style.width = (t/dur*100) + '%';
      const fmt = s => `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;
      document.getElementById('timeDisplay').textContent = `${fmt(t)} / ${fmt(dur)}`;
    }

    animFrame = requestAnimationFrame(renderFrame);
  }

  function togglePlay() {
    const btn = document.getElementById('playBtn');
    if (!isPlaying) {
      plateVideo.play();
      inkVideo.play();
      isPlaying = true;
      btn.textContent = '⏸ Pause';
      document.getElementById('statusBar').textContent = 'PLAYING';
    } else {
      plateVideo.pause();
      inkVideo.pause();
      isPlaying = false;
      btn.textContent = '▶ Play';
      document.getElementById('statusBar').textContent = 'PAUSED';
    }
  }

  function updatePreview() {
    if (processed) renderFrame();
  }

  function exportFrame() {
    const link = document.createElement('a');
    link.download = 'inkform-frame.png';
    link.href = outputCanvas.toDataURL('image/png');
    link.click();
  }

  // Re-render on slider changes (already wired via oninput)
</script>
</body>
</html>
