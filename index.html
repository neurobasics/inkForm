<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Rorschach Compositor</title>

<style>
html,body{
  margin:0;
  background:#000;
  color:#ccc;
  font-family:Helvetica,Arial,sans-serif;
  overflow:hidden;
}

/* LEFT PANEL */
#ui{
  position:fixed;
  left:0;
  top:0;
  bottom:0;
  width:300px;
  overflow-y:auto;
  background:#0b0b0b;
  padding:14px;
  box-sizing:border-box;
  font-size:.65rem;
  letter-spacing:.04em;
}

h2{
  font-size:.65rem;
  font-weight:600;
  margin:18px 0 8px;
  text-transform:uppercase;
  color:#666;
}

label{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
  color:#888;
}

input[type=range]{
  -webkit-appearance:none;
  width:120px;
  height:2px;
  background:#333;
  outline:none;
}

input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:10px;
  height:10px;
  background:#888;
  border-radius:50%;
  cursor:pointer;
}

button, select{
  background:#111;
  border:1px solid #222;
  color:#aaa;
  padding:4px 6px;
  font-size:.6rem;
  cursor:pointer;
}

button.on{
  background:#222;
  border-color:#444;
  color:#fff;
}

.section{
  margin-bottom:16px;
}

/* PREVIEW */
#previewWrap{
  position:absolute;
  left:300px;
  top:0;
  right:0;
  bottom:0;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#000;
}

canvas{
  max-width:100%;
  max-height:100%;
}
</style>
</head>

<body>

<div id="ui">

  <h2>Media</h2>
  <div class="section">
    <label>Ink Video <input type="file" id="inkUpload" accept="video/*"></label>
    <label>Plate Video <input type="file" id="plateUpload" accept="video/*"></label>
  </div>

  <h2>Composite Mode</h2>
  <div class="section">
    <button id="modeInkMasks" class="on">Ink Masks Person</button>
    <button id="modePersonCuts">Person Cuts Ink</button>
    <button id="modeSplit">Split</button>
  </div>

  <h2>Mirror</h2>
  <div class="section">
    <button id="mirrorH">Horizontal</button>
    <button id="mirrorV">Vertical</button>
  </div>

  <h2>Threshold</h2>
  <div class="section">
    <label>Ink Threshold <input type="range" id="inkThresh" min="0" max="255" value="120"></label>
    <label>Edge Feather <input type="range" id="edgeFeather" min="0" max="20" value="4"></label>
  </div>

  <h2>Color</h2>
  <div class="section">
    <button id="bwToggle">Black & White</button>
    <label>Saturation <input type="range" id="saturation" min="0" max="200" value="100"></label>
    <label>Contrast <input type="range" id="contrast" min="0" max="200" value="100"></label>
    <label>Brightness <input type="range" id="brightness" min="0" max="200" value="100"></label>
  </div>

  <h2>Background</h2>
  <div class="section">
    <button id="bgToggle" class="on">White Background</button>
  </div>

</div>

<div id="previewWrap">
  <canvas id="preview"></canvas>
</div>

<script>
const preview=document.getElementById('preview');
const ctx=preview.getContext('2d');

let inkVideo=document.createElement('video');
let plateVideo=document.createElement('video');
inkVideo.muted=true;
plateVideo.muted=true;

let compositeMode='inkMasksPerson';

document.getElementById('modeInkMasks').onclick=()=>{
  compositeMode='inkMasksPerson';
  setModeButtons(0);
}
document.getElementById('modePersonCuts').onclick=()=>{
  compositeMode='personCutsInk';
  setModeButtons(1);
}
document.getElementById('modeSplit').onclick=()=>{
  compositeMode='split';
  setModeButtons(2);
}

function setModeButtons(i){
  document.querySelectorAll('#ui button').forEach(b=>b.classList.remove('on'));
  document.querySelectorAll('#ui button')[i+2].classList.add('on');
}

document.getElementById('inkUpload').onchange=e=>{
  inkVideo.src=URL.createObjectURL(e.target.files[0]);
  inkVideo.play();
}
document.getElementById('plateUpload').onchange=e=>{
  plateVideo.src=URL.createObjectURL(e.target.files[0]);
  plateVideo.play();
}

function resize(){
  preview.width=window.innerWidth-300;
  preview.height=window.innerHeight;
}
window.onresize=resize;
resize();

function render(){
  requestAnimationFrame(render);
  if(!inkVideo.videoWidth||!plateVideo.videoWidth)return;

  ctx.clearRect(0,0,preview.width,preview.height);

  const W=preview.width;
  const H=preview.height;

  ctx.drawImage(inkVideo,0,0,W,H);
  const inkData=ctx.getImageData(0,0,W,H);
  const id=inkData.data;

  ctx.drawImage(plateVideo,0,0,W,H);
  const plateData=ctx.getImageData(0,0,W,H);
  const pd=plateData.data;

  const thresh=parseInt(document.getElementById('inkThresh').value);
  const feather=parseInt(document.getElementById('edgeFeather').value);

  const out=ctx.createImageData(W,H);
  const od=out.data;

  for(let i=0;i<id.length;i+=4){
    const lum=0.299*id[i]+0.587*id[i+1]+0.114*id[i+2];
    const mask=lum<thresh?1:0;

    if(compositeMode==='inkMasksPerson'){
      od[i]=pd[i];
      od[i+1]=pd[i+1];
      od[i+2]=pd[i+2];
      od[i+3]=mask*255;
    }
    else if(compositeMode==='personCutsInk'){
      od[i]=id[i];
      od[i+1]=id[i+1];
      od[i+2]=id[i+2];
      od[i+3]=255-mask*255;
    }
    else{
      if(i/4%W<W/2){
        od[i]=pd[i];
        od[i+1]=pd[i+1];
        od[i+2]=pd[i+2];
        od[i+3]=255;
      }else{
        od[i]=id[i];
        od[i+1]=id[i+1];
        od[i+2]=id[i+2];
        od[i+3]=255;
      }
    }
  }

  ctx.putImageData(out,0,0);
}

render();
</script>

</body>
</html>
