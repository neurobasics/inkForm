<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ink Rorschach Compositor</title>
<style>
body{
  margin:0;
  background:#111;
  color:white;
  font-family:sans-serif;
  display:flex;
  height:100vh;
}
#controls{
  width:320px;
  padding:15px;
  overflow-y:auto;
  background:#1a1a1a;
}
#viewer{
  flex:1;
  display:flex;
  flex-direction:column;
}
canvas{
  flex:1;
  background:black;
}
video{
  width:220px;
  position:absolute;
  bottom:20px;
  right:20px;
  border:1px solid #444;
}
input[type=range]{ width:100%; }
</style>
</head>
<body>

<div id="controls">
<h3>Upload</h3>
<input type="file" id="personUpload"><br><br>
<input type="file" id="inkUpload"><br><br>

<h3>Zoom</h3>
Zoom <input type="range" id="zoom" min="0.5" max="2" step="0.01" value="1"><br>

<h3>Mask</h3>
Threshold <input type="range" id="threshold" min="0" max="1" step="0.01" value="0.5"><br>
Softness <input type="range" id="softness" min="0" max="0.5" step="0.01" value="0.1"><br>

<h3>Position</h3>
Horizontal <input type="range" id="offsetX" min="-1" max="1" step="0.01" value="0"><br>
Vertical <input type="range" id="offsetY" min="-1" max="1" step="0.01" value="0"><br>

<h3>Seam</h3>
Width <input type="range" id="seamWidth" min="0" max="0.5" step="0.01" value="0.05"><br>
<label><input type="checkbox" id="seamInk"> Ink Seam</label><br>

<h3>Outline Ink</h3>
Outline Strength <input type="range" id="outlineStrength" min="0" max="3" step="0.1" value="1"><br>

<h3>Ramp</h3>
Strength <input type="range" id="rampStrength" min="0" max="2" step="0.01" value="1"><br>
<label><input type="checkbox" id="rampMasked"> Ramp Only Inside Mask</label><br>
</div>

<div id="viewer">
<canvas id="canvas"></canvas>
<video id="personVideo" autoplay loop muted></video>
<video id="inkVideo" autoplay loop muted style="display:none;"></video>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d",{willReadFrequently:true});

const personVideo = document.getElementById("personVideo");
const inkVideo = document.getElementById("inkVideo");

const zoom = document.getElementById("zoom");
const threshold = document.getElementById("threshold");
const softness = document.getElementById("softness");
const offsetX = document.getElementById("offsetX");
const offsetY = document.getElementById("offsetY");
const seamWidth = document.getElementById("seamWidth");
const seamInk = document.getElementById("seamInk");
const outlineStrength = document.getElementById("outlineStrength");
const rampStrength = document.getElementById("rampStrength");
const rampMasked = document.getElementById("rampMasked");

function resize(){
  canvas.width = window.innerWidth - 320;
  canvas.height = window.innerHeight;
}
window.onresize = resize;
resize();

personUpload.onchange = e=>{
  personVideo.src = URL.createObjectURL(e.target.files[0]);
}
inkUpload.onchange = e=>{
  inkVideo.src = URL.createObjectURL(e.target.files[0]);
}

function smoothstep(a,b,x){
  let t=Math.min(Math.max((x-a)/(b-a),0),1);
  return t*t*(3-2*t);
}

function render(){
if(personVideo.readyState>=2 && inkVideo.readyState>=2){

let w=canvas.width;
let h=canvas.height;

ctx.clearRect(0,0,w,h);

// draw person with zoom + offset
ctx.save();
ctx.translate(w/2,h/2);
ctx.scale(zoom.value,zoom.value);
ctx.drawImage(
  personVideo,
  -w/2 + offsetX.value*w,
  -h/2 + offsetY.value*h,
  w,
  h
);
ctx.restore();

let personData=ctx.getImageData(0,0,w,h);
ctx.clearRect(0,0,w,h);

ctx.drawImage(inkVideo,0,0,w,h);
let inkData=ctx.getImageData(0,0,w,h);
ctx.clearRect(0,0,w,h);

let output=ctx.createImageData(w,h);

for(let y=0;y<h;y++){
for(let x=0;x<w;x++){

let mirrorX=Math.abs(x-w/2)+w/2;
if(mirrorX>=w) mirrorX=w-1;

let i=(y*w+x)*4;
let mi=(y*w+mirrorX)*4;

let lum=(inkData.data[i]*0.299+
         inkData.data[i+1]*0.587+
         inkData.data[i+2]*0.114)/255;

let mask=smoothstep(
  threshold.value-softness.value,
  threshold.value+softness.value,
  lum
);

// seam fade
let seamDist=Math.abs(x-w/2)/w;
let seamFade=1-smoothstep(0,seamWidth.value,seamDist);
if(seamInk.checked) mask*= (1-seamFade);

// outline ink
let edge=Math.abs(mask - smoothstep(
  threshold.value-softness.value,
  threshold.value+softness.value,
  lum+0.02
));
mask += edge * outlineStrength.value;

// ramp
let ramp=1+rampStrength.value*(y/h);
if(rampMasked.checked) ramp=1+rampStrength.value*(y/h)*mask;

output.data[i]=personData.data[mi]*mask*ramp;
output.data[i+1]=personData.data[mi+1]*mask*ramp;
output.data[i+2]=personData.data[mi+2]*mask*ramp;
output.data[i+3]=255;
}
}

ctx.putImageData(output,0,0);
}

requestAnimationFrame(render);
}

render();
</script>
</body>
</html>
